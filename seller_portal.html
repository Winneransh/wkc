<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Seller Portal - Supply Chain Management</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }
        
        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: linear-gradient(135deg, #f5f7fa 0%, #c3cfe2 100%);
            min-height: 100vh;
            color: #333;
        }
        
        .header {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            padding: 1.5rem 0;
            box-shadow: 0 4px 15px rgba(0,0,0,0.1);
        }
        
        .header .container {
            max-width: 1200px;
            margin: 0 auto;
            padding: 0 1rem;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        
        .header h1 {
            font-size: 1.8rem;
            font-weight: 600;
        }
        
        .seller-info-header {
            text-align: right;
            opacity: 0.9;
        }
        
        .container {
            max-width: 1200px;
            margin: 0 auto;
            padding: 2rem 1rem;
        }
        
        .login-section {
            background: white;
            border-radius: 15px;
            padding: 3rem;
            box-shadow: 0 10px 30px rgba(0,0,0,0.1);
            max-width: 500px;
            margin: 3rem auto;
            text-align: center;
        }
        
        .login-section h2 {
            color: #667eea;
            margin-bottom: 2rem;
            font-weight: 600;
        }
        
        .form-group {
            margin-bottom: 1.5rem;
            text-align: left;
        }
        
        .form-group label {
            display: block;
            margin-bottom: 0.5rem;
            font-weight: 500;
            color: #4a5568;
        }
        
        .form-group input,
        .form-group select,
        .form-group textarea {
            width: 100%;
            padding: 0.75rem 1rem;
            border: 2px solid #e2e8f0;
            border-radius: 8px;
            font-size: 1rem;
            transition: all 0.3s ease;
        }
        
        .form-group input:focus,
        .form-group select:focus,
        .form-group textarea:focus {
            outline: none;
            border-color: #667eea;
            box-shadow: 0 0 0 3px rgba(102, 126, 234, 0.1);
        }
        
        .btn {
            padding: 0.75rem 2rem;
            border: none;
            border-radius: 8px;
            cursor: pointer;
            font-size: 1rem;
            font-weight: 500;
            transition: all 0.3s ease;
            text-decoration: none;
            display: inline-block;
        }
        
        .btn-primary {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
        }
        
        .btn-primary:hover {
            transform: translateY(-2px);
            box-shadow: 0 5px 15px rgba(102, 126, 234, 0.4);
        }
        
        .btn-success {
            background: linear-gradient(135deg, #48bb78 0%, #38a169 100%);
            color: white;
        }
        
        .btn-success:hover {
            transform: translateY(-2px);
            box-shadow: 0 5px 15px rgba(72, 187, 120, 0.4);
        }
        
        .btn-danger {
            background: linear-gradient(135deg, #f56565 0%, #e53e3e 100%);
            color: white;
        }
        
        .btn-secondary {
            background: #e2e8f0;
            color: #4a5568;
        }
        
        .dashboard {
            display: none;
        }
        
        .stats-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
            gap: 1.5rem;
            margin-bottom: 2rem;
        }
        
        .stat-card {
            background: white;
            border-radius: 15px;
            padding: 2rem;
            box-shadow: 0 5px 20px rgba(0,0,0,0.08);
            text-align: center;
            transition: transform 0.3s ease;
        }
        
        .stat-card:hover {
            transform: translateY(-5px);
        }
        
        .stat-card .value {
            font-size: 2.5rem;
            font-weight: 700;
            color: #667eea;
            margin-bottom: 0.5rem;
        }
        
        .stat-card .label {
            color: #718096;
            font-weight: 500;
        }
        
        .section {
            background: white;
            border-radius: 15px;
            padding: 2rem;
            box-shadow: 0 5px 20px rgba(0,0,0,0.08);
            margin-bottom: 2rem;
        }
        
        .section h3 {
            color: #2d3748;
            margin-bottom: 1.5rem;
            font-weight: 600;
            border-bottom: 2px solid #e2e8f0;
            padding-bottom: 0.5rem;
        }
        
        .request-card {
            border: 2px solid #e2e8f0;
            border-radius: 12px;
            padding: 1.5rem;
            margin-bottom: 1rem;
            transition: all 0.3s ease;
            position: relative;
            overflow: hidden;
        }
        
        .request-card::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            height: 4px;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
        }
        
        .request-card:hover {
            border-color: #667eea;
            box-shadow: 0 5px 15px rgba(102, 126, 234, 0.1);
        }
        
        .request-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 1rem;
        }
        
        .request-header h4 {
            color: #2d3748;
            font-weight: 600;
        }
        
        .badge {
            padding: 0.25rem 0.75rem;
            border-radius: 20px;
            font-size: 0.875rem;
            font-weight: 500;
        }
        
        .badge-urgent {
            background: #fed7d7;
            color: #c53030;
        }
        
        .badge-normal {
            background: #bee3f8;
            color: #2c5282;
        }
        
        .badge-active {
            background: #c6f6d5;
            color: #22543d;
        }
        
        .request-details {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 1rem;
            margin-bottom: 1.5rem;
        }
        
        .detail-item {
            display: flex;
            flex-direction: column;
        }
        
        .detail-label {
            font-weight: 500;
            color: #718096;
            font-size: 0.875rem;
            margin-bottom: 0.25rem;
        }
        
        .detail-value {
            color: #2d3748;
            font-weight: 600;
        }
        
        .modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0,0,0,0.5);
            justify-content: center;
            align-items: center;
            z-index: 1000;
        }
        
        .modal-content {
            background: white;
            border-radius: 15px;
            padding: 2rem;
            max-width: 600px;
            width: 90%;
            max-height: 80vh;
            overflow-y: auto;
            box-shadow: 0 20px 60px rgba(0,0,0,0.3);
        }
        
        .modal-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 2rem;
            border-bottom: 2px solid #e2e8f0;
            padding-bottom: 1rem;
        }
        
        .modal-header h3 {
            color: #2d3748;
            font-weight: 600;
            margin: 0;
        }
        
        .close-btn {
            background: none;
            border: none;
            font-size: 1.5rem;
            cursor: pointer;
            color: #718096;
            transition: color 0.3s ease;
        }
        
        .close-btn:hover {
            color: #2d3748;
        }
        
        .response-options {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 1rem;
            margin-bottom: 2rem;
        }
        
        .option-card {
            border: 2px solid #e2e8f0;
            border-radius: 12px;
            padding: 1.5rem;
            cursor: pointer;
            transition: all 0.3s ease;
            text-align: center;
        }
        
        .option-card:hover {
            border-color: #667eea;
        }
        
        .option-card.selected {
            border-color: #667eea;
            background: #f7fafc;
        }
        
        .option-card .icon {
            font-size: 2rem;
            margin-bottom: 0.5rem;
        }
        
        .loading {
            display: inline-block;
            width: 20px;
            height: 20px;
            border: 3px solid #f3f4f6;
            border-top: 3px solid #667eea;
            border-radius: 50%;
            animation: spin 1s linear infinite;
        }
        
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
        
        .no-data {
            text-align: center;
            color: #718096;
            font-style: italic;
            padding: 2rem;
        }
        
        .success-message {
            background: #c6f6d5;
            color: #22543d;
            padding: 1rem;
            border-radius: 8px;
            margin-bottom: 1rem;
            border-left: 4px solid #38a169;
        }
        
        .error-message {
            background: #fed7d7;
            color: #c53030;
            padding: 1rem;
            border-radius: 8px;
            margin-bottom: 1rem;
            border-left: 4px solid #e53e3e;
        }
        
        .negotiation-messages {
            max-height: 300px;
            overflow-y: auto;
            border: 1px solid #e2e8f0;
            border-radius: 8px;
            padding: 1rem;
            margin-bottom: 1rem;
            background: #f7fafc;
        }
        
        .message {
            margin-bottom: 1rem;
            padding: 1rem;
            border-radius: 8px;
        }
        
        .message-buyer {
            background: #ebf8ff;
            border-left: 4px solid #3182ce;
        }
        
        .message-seller {
            background: #f0fff4;
            border-left: 4px solid #38a169;
        }
        
        .message-header {
            font-weight: 600;
            margin-bottom: 0.5rem;
            color: #2d3748;
        }
        
        .message-content {
            color: #4a5568;
            line-height: 1.5;
        }
        
        .seller-id-examples {
            background: #f7fafc;
            border: 1px solid #e2e8f0;
            border-radius: 8px;
            padding: 1rem;
            margin-top: 1rem;
        }
        
        .seller-id-examples h4 {
            color: #2d3748;
            margin-bottom: 0.5rem;
            font-size: 0.9rem;
        }
        
        .seller-id-examples .examples {
            font-family: monospace;
            font-size: 0.85rem;
            color: #667eea;
        }
        
        .tabs {
            display: flex;
            border-bottom: 2px solid #e2e8f0;
            margin-bottom: 2rem;
        }
        
        .tab {
            padding: 1rem 2rem;
            background: none;
            border: none;
            cursor: pointer;
            font-size: 1rem;
            color: #718096;
            transition: all 0.3s ease;
            border-bottom: 3px solid transparent;
            font-weight: 500;
        }
        
        .tab:hover {
            color: #4a5568;
            background: #f7fafc;
        }
        
        .tab.active {
            color: #667eea;
            border-bottom-color: #667eea;
        }
        
        .tab-content {
            display: none;
        }
        
        .tab-content.active {
            display: block;
        }
        
        .negotiation-card {
            border: 2px solid #e2e8f0;
            border-radius: 12px;
            padding: 1.5rem;
            margin-bottom: 1rem;
            transition: all 0.3s ease;
        }
        
        .negotiation-card:hover {
            border-color: #667eea;
            box-shadow: 0 5px 15px rgba(102, 126, 234, 0.1);
        }
        
        .negotiation-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 1rem;
        }
        
        .negotiation-summary {
            background: #f7fafc;
            padding: 1rem;
            border-radius: 8px;
            margin-bottom: 1rem;
            border-left: 4px solid #667eea;
        }
        
        @media (max-width: 768px) {
            .stats-grid {
                grid-template-columns: 1fr;
            }
            
            .request-details {
                grid-template-columns: 1fr;
            }
            
            .response-options {
                grid-template-columns: 1fr;
            }
            
            .tabs {
                flex-direction: column;
            }
            
            .tab {
                text-align: left;
                border-bottom: 1px solid #e2e8f0;
            }
        }
    </style>
</head>
<body>
    <!-- Header -->
    <div class="header">
        <div class="container">
            <h1>🏪 Seller Portal</h1>
            <div class="seller-info-header" id="headerInfo" style="display: none;">
                <div id="sellerName">-</div>
                <div style="font-size: 0.9rem;" id="sellerLocation">-</div>
                <button class="btn btn-secondary" onclick="logout()" style="margin-top: 0.5rem; font-size: 0.8rem; padding: 0.5rem 1rem;">
                    🚪 Logout
                </button>
            </div>
        </div>
    </div>

    <!-- Login Section -->
    <div id="loginSection" class="login-section">
        <h2>Welcome to Seller Portal</h2>
        <p style="color: #718096; margin-bottom: 2rem;">Enter your seller ID to access your dashboard</p>
        
        <div class="form-group">
            <label for="sellerIdInput">Seller ID</label>
            <input 
                type="text" 
                id="sellerIdInput" 
                placeholder="e.g., SELL_5005_01"
                autocomplete="off"
            >
        </div>
        
        <button class="btn btn-primary" onclick="loginSeller()">
            <span id="loginBtnText">Access Dashboard</span>
            <span id="loginLoading" class="loading" style="display: none;"></span>
        </button>
        
        <div class="seller-id-examples">
            <h4>Example Seller IDs:</h4>
            <div class="examples">
                SELL_5001_01 • SELL_5001_02 • SELL_5001_03 (Mangoes)<br>
                SELL_5005_01 • SELL_5005_02 • SELL_5005_03 (Bread)<br>
                SELL_5006_01 • SELL_5006_02 • SELL_5006_03 (Cooking Oil)
            </div>
        </div>
    </div>

    <!-- Dashboard -->
    <div id="dashboard" class="dashboard">
        <div class="container">
            <!-- Stats Grid -->
            <div class="stats-grid">
                <div class="stat-card">
                    <div class="value" id="totalRequests">-</div>
                    <div class="label">Total Requests</div>
                </div>
                <div class="stat-card">
                    <div class="value" id="acceptanceRate">-</div>
                    <div class="label">Acceptance Rate</div>
                </div>
                <div class="stat-card">
                    <div class="value" id="reliabilityScore">-</div>
                    <div class="label">Reliability Score</div>
                </div>
                <div class="stat-card">
                    <div class="value" id="activeNegotiationsCount">-</div>
                    <div class="label">Active Negotiations</div>
                </div>
            </div>

            <!-- Seller Information -->
            <div class="section">
                <h3>👤 Your Information</h3>
                <div id="sellerDetails" class="request-details">
                    <!-- Seller details will be populated here -->
                </div>
            </div>

            <!-- Tabs -->
            <div class="tabs">
                <button class="tab active" onclick="showTab('requests')">🔔 Active Requests</button>
                <button class="tab" onclick="showTab('negotiations')">💬 Negotiations</button>
                <button class="tab" onclick="showTab('history')">📋 History</button>
            </div>

            <!-- Active Requests Tab -->
            <div id="requestsTab" class="tab-content active">
                <div class="section">
                    <h3>📋 Active Requests</h3>
                    <div id="activeRequests">
                        <div class="loading"></div>
                    </div>
                </div>
            </div>

            <!-- Negotiations Tab -->
            <div id="negotiationsTab" class="tab-content">
                <div class="section">
                    <h3>💬 Active Negotiations</h3>
                    <div id="activeNegotiations">
                        <div class="loading"></div>
                    </div>
                </div>
            </div>

            <!-- History Tab -->
            <div id="historyTab" class="tab-content">
                <div class="section">
                    <h3>📈 Request History</h3>
                    <div id="requestHistory">
                        <div class="loading"></div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Response Modal -->
    <div id="responseModal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h3>📝 Submit Response</h3>
                <button class="close-btn" onclick="closeModal('responseModal')">&times;</button>
            </div>
            
            <div id="modalRequestInfo" class="request-card" style="margin-bottom: 2rem;">
                <!-- Request details will be populated here -->
            </div>

            <div class="response-options">
                <div class="option-card" onclick="selectResponse('accept')">
                    <div class="icon">✅</div>
                    <div><strong>Accept Request</strong></div>
                    <div style="font-size: 0.8rem; color: #718096;">Provide your quote</div>
                </div>
                <div class="option-card" onclick="selectResponse('decline')">
                    <div class="icon">❌</div>
                    <div><strong>Decline Request</strong></div>
                    <div style="font-size: 0.8rem; color: #718096;">Cannot fulfill this order</div>
                </div>
            </div>

            <div id="acceptFields" style="display: none;">
                <div class="form-group">
                    <label>💰 Your Quoted Price (₹ per unit)</label>
                    <input type="number" id="quotedPrice" step="0.01" placeholder="Enter your best price">
                </div>
                <div class="form-group">
                    <label>🚚 Expected Delivery Days</label>
                    <input type="number" id="deliveryDays" placeholder="Number of days">
                </div>
                <div class="form-group">
                    <label>📝 Additional Notes (Optional)</label>
                    <textarea id="additionalNotes" rows="3" placeholder="Any special terms, conditions, or notes..."></textarea>
                </div>
            </div>

            <button class="btn btn-primary" onclick="submitResponse()" style="width: 100%;">
                <span id="submitBtnText">Submit Response</span>
                <span id="submitLoading" class="loading" style="display: none;"></span>
            </button>
        </div>
    </div>

    <!-- Negotiation Modal -->
    <div id="negotiationModal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h3>💬 Negotiation Details</h3>
                <button class="close-btn" onclick="closeModal('negotiationModal')">&times;</button>
            </div>
            
            <div id="negotiationInfo" class="negotiation-summary">
                <!-- Negotiation summary will be populated here -->
            </div>
            
            <div class="negotiation-messages" id="negotiationMessages">
                <!-- Messages will be populated here -->
            </div>
            
            <div class="form-group">
                <label>💬 Your Response Message</label>
                <textarea id="negotiationMessage" rows="3" placeholder="Type your response..."></textarea>
            </div>
            
            <div class="form-group">
                <label>💰 Counter Offer Price (₹)</label>
                <input type="number" id="counterPrice" step="0.01" placeholder="Your counter offer price">
            </div>
            
            <div class="form-group">
                <label>🚚 Counter Offer Delivery Days</label>
                <input type="number" id="counterDelivery" placeholder="Delivery days">
            </div>
            
            <button class="btn btn-primary" onclick="submitNegotiationResponse()" style="width: 100%;">
                Send Response
            </button>
        </div>
    </div>

    <script>
        const API_BASE = 'http://localhost:8000';
        let currentSellerId = null;
        let currentRequestId = null;
        let currentNegotiationId = null;
        let currentProductId = null;
        let selectedResponse = null;

        // Initialize
        document.addEventListener('DOMContentLoaded', function() {
            // Auto-focus on seller ID input
            document.getElementById('sellerIdInput').focus();
            
            // Allow Enter key to login
            document.getElementById('sellerIdInput').addEventListener('keypress', function(e) {
                if (e.key === 'Enter') {
                    loginSeller();
                }
            });
        });

        // Login Functions
        async function loginSeller() {
            const sellerId = document.getElementById('sellerIdInput').value.trim();
            if (!sellerId) {
                showError('Please enter your seller ID');
                return;
            }

            const loginBtn = document.getElementById('loginBtnText');
            const loginLoading = document.getElementById('loginLoading');
            
            loginBtn.style.display = 'none';
            loginLoading.style.display = 'inline-block';

            try {
                const response = await fetch(`${API_BASE}/api/sellers/${sellerId}`);
                if (!response.ok) {
                    throw new Error('Seller not found');
                }
                
                const data = await response.json();
                currentSellerId = sellerId;
                
                // Hide login, show dashboard
                document.getElementById('loginSection').style.display = 'none';
                document.getElementById('dashboard').style.display = 'block';
                
                // Update header
                document.getElementById('headerInfo').style.display = 'block';
                document.getElementById('sellerName').textContent = data.seller_info.company_name;
                document.getElementById('sellerLocation').textContent = data.seller_info.location;
                
                // Load dashboard data
                await loadSellerDashboard(data.seller_info);
                
            } catch (error) {
                console.error('Login error:', error);
                showError('Invalid seller ID. Please check and try again.');
            } finally {
                loginBtn.style.display = 'inline';
                loginLoading.style.display = 'none';
            }
        }

        // Dashboard Functions
        async function loadSellerDashboard(sellerInfo) {
            try {
                // Update seller details
                document.getElementById('sellerDetails').innerHTML = `
                    <div class="detail-item">
                        <div class="detail-label">Company</div>
                        <div class="detail-value">${sellerInfo.company_name}</div>
                    </div>
                    <div class="detail-item">
                        <div class="detail-label">Product</div>
                        <div class="detail-value">${sellerInfo.product_name}</div>
                    </div>
                    <div class="detail-item">
                        <div class="detail-label">Location</div>
                        <div class="detail-value">${sellerInfo.location}</div>
                    </div>
                    <div class="detail-item">
                        <div class="detail-label">Contact</div>
                        <div class="detail-value">${sellerInfo.contact_person}</div>
                    </div>
                    <div class="detail-item">
                        <div class="detail-label">Phone</div>
                        <div class="detail-value">${sellerInfo.phone_number}</div>
                    </div>
                    <div class="detail-item">
                        <div class="detail-label">Payment Terms</div>
                        <div class="detail-value">${sellerInfo.payment_terms}</div>
                    </div>
                `;

                // Update stats
                document.getElementById('reliabilityScore').textContent = sellerInfo.reliability_score + '%';
                
                // Load analytics
                try {
                    const analyticsResponse = await fetch(`${API_BASE}/api/analytics/seller/${currentSellerId}`);
                    if (analyticsResponse.ok) {
                        const analytics = await analyticsResponse.json();
                        document.getElementById('totalRequests').textContent = analytics.performance_metrics.total_requests_received;
                        document.getElementById('acceptanceRate').textContent = analytics.performance_metrics.acceptance_rate.toFixed(1) + '%';
                    }
                } catch (e) {
                    console.error('Analytics error:', e);
                    document.getElementById('totalRequests').textContent = '0';
                    document.getElementById('acceptanceRate').textContent = '0%';
                }

                // Load active data
                await loadActiveRequests();
                await loadNegotiations();
                await loadHistory();
                
            } catch (error) {
                console.error('Error loading dashboard:', error);
                showError('Error loading dashboard data');
            }
        }

        async function loadActiveRequests() {
            try {
                const response = await fetch(`${API_BASE}/api/sellers/${currentSellerId}/requests`);
                const data = await response.json();
                
                const requestsDiv = document.getElementById('activeRequests');
                
                if (!data.active_requests || data.active_requests.length === 0) {
                    requestsDiv.innerHTML = '<div class="no-data">📭 No active requests at the moment</div>';
                    return;
                }

                requestsDiv.innerHTML = data.active_requests.map(request => `
                    <div class="request-card">
                        <div class="request-header">
                            <h4>🛒 ${request.product_name}</h4>
                            <span class="badge badge-normal">New Request</span>
                        </div>
                        <div class="request-details">
                            <div class="detail-item">
                                <div class="detail-label">Quantity Needed</div>
                                <div class="detail-value">${request.quantity_requested} units</div>
                            </div>
                            <div class="detail-item">
                                <div class="detail-label">Request Date</div>
                                <div class="detail-value">${new Date(request.request_date).toLocaleDateString()}</div>
                            </div>
                            <div class="detail-item">
                                <div class="detail-label">Response Deadline</div>
                                <div class="detail-value">${new Date(request.deadline).toLocaleDateString()}</div>
                            </div>
                        </div>
                        <button class="btn btn-primary" onclick="openResponseModal('${request.request_id}', ${request.product_id}, '${request.product_name}', ${request.quantity_requested})">
                            📝 Submit Response
                        </button>
                    </div>
                `).join('');
                
            } catch (error) {
                console.error('Error loading requests:', error);
                document.getElementById('activeRequests').innerHTML = '<div class="error-message">Error loading requests</div>';
            }
        }

        async function loadNegotiations() {
            try {
                const response = await fetch(`${API_BASE}/api/negotiations/active`);
                const data = await response.json();
                
                const negotiationsDiv = document.getElementById('activeNegotiations');
                
                // Filter negotiations for current seller
                const myNegotiations = data.active_negotiations.filter(neg => neg.seller_id === currentSellerId);
                
                // Update negotiation count in stats
                document.getElementById('activeNegotiationsCount').textContent = myNegotiations.length;
                
                if (myNegotiations.length === 0) {
                    negotiationsDiv.innerHTML = '<div class="no-data">💬 No active negotiations</div>';
                    return;
                }

                negotiationsDiv.innerHTML = myNegotiations.map(negotiation => `
                    <div class="negotiation-card">
                        <div class="negotiation-header">
                            <h4>💬 ${negotiation.company_name}</h4>
                            <span class="badge badge-active">Round ${negotiation.current_round}</span>
                        </div>
                        <div class="negotiation-summary">
                            <strong>Latest Message:</strong><br>
                            "${negotiation.last_message ? negotiation.last_message.message.substring(0, 100) + '...' : 'No messages yet'}"
                        </div>
                        <div class="request-details">
                            <div class="detail-item">
                                <div class="detail-label">Product ID</div>
                                <div class="detail-value">${negotiation.product_id}</div>
                            </div>
                            <div class="detail-item">
                                <div class="detail-label">Current Round</div>
                                <div class="detail-value">${negotiation.current_round}</div>
                            </div>
                            <div class="detail-item">
                                <div class="detail-label">Proposed Price</div>
                                <div class="detail-value">₹${negotiation.last_message?.proposed_price || 'N/A'}</div>
                            </div>
                            <div class="detail-item">
                                <div class="detail-label">Proposed Delivery</div>
                                <div class="detail-value">${negotiation.last_message?.proposed_delivery || 'N/A'} days</div>
                            </div>
                        </div>
                        <button class="btn btn-success" onclick="openNegotiationModal('${negotiation.negotiation_id}')">
                            💬 View & Respond
                        </button>
                    </div>
                `).join('');
                
            } catch (error) {
                console.error('Error loading negotiations:', error);
                document.getElementById('activeNegotiations').innerHTML = '<div class="error-message">Error loading negotiations</div>';
                document.getElementById('activeNegotiationsCount').textContent = '0';
            }
        }

        async function loadHistory() {
            // Implementation for loading history
            const historyDiv = document.getElementById('requestHistory');
            historyDiv.innerHTML = '<div class="no-data">📋 Request history will be shown here</div>';
        }

        // Tab Management
        function showTab(tabName) {
            // Remove active class from all tabs and contents
            document.querySelectorAll('.tab').forEach(tab => tab.classList.remove('active'));
            document.querySelectorAll('.tab-content').forEach(content => content.classList.remove('active'));
            
            // Add active class to clicked tab and corresponding content
            event.target.classList.add('active');
            document.getElementById(tabName + 'Tab').classList.add('active');
            
            // Refresh data based on tab
            if (tabName === 'requests') {
                loadActiveRequests();
            } else if (tabName === 'negotiations') {
                loadNegotiations();
            } else if (tabName === 'history') {
                loadHistory();
            }
        }

        // Response Modal Functions
        function openResponseModal(requestId, productId, productName, quantity) {
            currentRequestId = requestId;
            currentProductId = productId;
            
            // Update modal request info
            document.getElementById('modalRequestInfo').innerHTML = `
                <div class="request-header">
                    <h4>🛒 ${productName}</h4>
                    <span class="badge badge-normal">Request Details</span>
                </div>
                <div class="request-details">
                    <div class="detail-item">
                        <div class="detail-label">Quantity Requested</div>
                        <div class="detail-value">${quantity} units</div>
                    </div>
                    <div class="detail-item">
                        <div class="detail-label">Request ID</div>
                        <div class="detail-value">${requestId}</div>
                    </div>
                </div>
            `;
            
            // Reset form
            selectedResponse = null;
            document.querySelectorAll('.option-card').forEach(card => card.classList.remove('selected'));
            document.getElementById('acceptFields').style.display = 'none';
            document.getElementById('quotedPrice').value = '';
            document.getElementById('deliveryDays').value = '';
            document.getElementById('additionalNotes').value = '';
            
            document.getElementById('responseModal').style.display = 'flex';
        }

        function selectResponse(type) {
            selectedResponse = type;
            
            // Update UI
            document.querySelectorAll('.option-card').forEach(card => card.classList.remove('selected'));
            event.target.closest('.option-card').classList.add('selected');
            
            // Show/hide accept fields
            document.getElementById('acceptFields').style.display = type === 'accept' ? 'block' : 'none';
        }

        async function submitResponse() {
            if (!selectedResponse) {
                showError('Please select accept or decline');
                return;
            }

            let responseData = {
                seller_id: currentSellerId,
                product_id: currentProductId,
                request_id: currentRequestId,
                response: selectedResponse === 'accept' ? 'yes' : 'no'
            };

            if (selectedResponse === 'accept') {
                const price = document.getElementById('quotedPrice').value;
                const days = document.getElementById('deliveryDays').value;
                
                if (!price || !days) {
                    showError('Please provide both price and delivery days for acceptance');
                    return;
                }
                
                responseData.quoted_price = parseFloat(price);
                responseData.expected_delivery_days = parseInt(days);
                responseData.additional_notes = document.getElementById('additionalNotes').value;
            }

            const submitBtn = document.getElementById('submitBtnText');
            const submitLoading = document.getElementById('submitLoading');
            
            submitBtn.style.display = 'none';
            submitLoading.style.display = 'inline-block';

            try {
                const response = await fetch(`${API_BASE}/api/responses/submit`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify(responseData)
                });

                if (!response.ok) {
                    const errorData = await response.json();
                    throw new Error(errorData.detail || 'Failed to submit response');
                }

                const result = await response.json();
                showSuccess('Response submitted successfully!' + (result.auto_negotiation_started ? ' Negotiations may start automatically.' : ''));
                closeModal('responseModal');
                await loadActiveRequests(); // Refresh the requests list
                await loadNegotiations(); // Refresh negotiations in case they started
                
            } catch (error) {
                console.error('Error submitting response:', error);
                showError('Failed to submit response: ' + error.message);
            } finally {
                submitBtn.style.display = 'inline';
                submitLoading.style.display = 'none';
            }
        }

        // Negotiation Functions
        async function openNegotiationModal(negotiationId) {
            currentNegotiationId = negotiationId;
            
            try {
                // Load negotiation details
                const response = await fetch(`${API_BASE}/api/negotiations/${negotiationId}`);
                if (!response.ok) {
                    throw new Error('Failed to load negotiation details');
                }
                
                const negotiation = await response.json();
                
                // Update negotiation info
                document.getElementById('negotiationInfo').innerHTML = `
                    <strong>Negotiation with:</strong> ${negotiation.company_name}<br>
                    <strong>Product ID:</strong> ${negotiation.product_id}<br>
                    <strong>Current Round:</strong> ${negotiation.current_round}<br>
                    <strong>Status:</strong> ${negotiation.status}<br>
                    <strong>Initial Price:</strong> ₹${negotiation.initial_quoted_price}<br>
                    <strong>Initial Delivery:</strong> ${negotiation.initial_delivery_days} days
                `;
                
                // Display messages
                const messagesDiv = document.getElementById('negotiationMessages');
                if (negotiation.messages && negotiation.messages.length > 0) {
                    messagesDiv.innerHTML = negotiation.messages.map(msg => `
                        <div class="message message-${msg.from}">
                            <div class="message-header">
                                ${msg.from === 'buyer' ? '🏢 Buyer' : '🏪 Seller'} - Round ${msg.round}
                                <span style="float: right; font-size: 0.8rem;">${msg.timestamp}</span>
                            </div>
                            <div class="message-content">
                                ${msg.message}
                                ${msg.proposed_price ? `<br><strong>Proposed Price:</strong> ₹${msg.proposed_price}` : ''}
                                ${msg.proposed_delivery ? `<br><strong>Proposed Delivery:</strong> ${msg.proposed_delivery} days` : ''}
                            </div>
                        </div>
                    `).join('');
                } else {
                    messagesDiv.innerHTML = '<div class="no-data">No messages yet</div>';
                }
                
                // Clear form
                document.getElementById('negotiationMessage').value = '';
                document.getElementById('counterPrice').value = '';
                document.getElementById('counterDelivery').value = '';
                
                document.getElementById('negotiationModal').style.display = 'flex';
                
            } catch (error) {
                console.error('Error loading negotiation:', error);
                showError('Failed to load negotiation details');
            }
        }

        async function submitNegotiationResponse() {
            const message = document.getElementById('negotiationMessage').value;
            const counterPrice = document.getElementById('counterPrice').value;
            const counterDelivery = document.getElementById('counterDelivery').value;

            if (!message.trim()) {
                showError('Please enter a message');
                return;
            }

            try {
                const response = await fetch(`${API_BASE}/api/negotiations/${currentNegotiationId}/respond`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({
                        seller_id: currentSellerId,
                        message: message,
                        counter_offer_price: counterPrice ? parseFloat(counterPrice) : null,
                        counter_offer_delivery: counterDelivery ? parseInt(counterDelivery) : null
                    })
                });

                if (!response.ok) {
                    const errorData = await response.json();
                    throw new Error(errorData.detail || 'Failed to submit negotiation response');
                }

                const result = await response.json();
                showSuccess('Negotiation response sent successfully!');
                closeModal('negotiationModal');
                await loadNegotiations(); // Refresh negotiations
                
                // Show buyer's response if available
                if (result.buyer_response) {
                    showSuccess('Buyer responded: ' + result.buyer_response.substring(0, 100) + '...');
                }
                
            } catch (error) {
                console.error('Error submitting negotiation:', error);
                showError('Failed to submit negotiation response: ' + error.message);
            }
        }

        // Utility Functions
        function closeModal(modalId) {
            document.getElementById(modalId).style.display = 'none';
        }

        function showError(message) {
            // Create temporary error message
            const errorDiv = document.createElement('div');
            errorDiv.className = 'error-message';
            errorDiv.textContent = message;
            errorDiv.style.position = 'fixed';
            errorDiv.style.top = '20px';
            errorDiv.style.right = '20px';
            errorDiv.style.zIndex = '9999';
            errorDiv.style.maxWidth = '300px';
            
            document.body.appendChild(errorDiv);
            
            setTimeout(() => {
                if (document.body.contains(errorDiv)) {
                    document.body.removeChild(errorDiv);
                }
            }, 5000);
        }

        function showSuccess(message) {
            // Create temporary success message
            const successDiv = document.createElement('div');
            successDiv.className = 'success-message';
            successDiv.textContent = message;
            successDiv.style.position = 'fixed';
            successDiv.style.top = '20px';
            successDiv.style.right = '20px';
            successDiv.style.zIndex = '9999';
            successDiv.style.maxWidth = '300px';
            
            document.body.appendChild(successDiv);
            
            setTimeout(() => {
                if (document.body.contains(successDiv)) {
                    document.body.removeChild(successDiv);
                }
            }, 5000);
        }

        function logout() {
            currentSellerId = null;
            currentRequestId = null;
            currentNegotiationId = null;
            currentProductId = null;
            selectedResponse = null;
            
            document.getElementById('dashboard').style.display = 'none';
            document.getElementById('loginSection').style.display = 'block';
            document.getElementById('headerInfo').style.display = 'none';
            document.getElementById('sellerIdInput').value = '';
            document.getElementById('sellerIdInput').focus();
        }

        // Auto-refresh active requests and negotiations every 30 seconds
        setInterval(() => {
            if (currentSellerId) {
                if (document.getElementById('requestsTab').classList.contains('active')) {
                    loadActiveRequests();
                }
                if (document.getElementById('negotiationsTab').classList.contains('active')) {
                    loadNegotiations();
                }
            }
        }, 30000);

        // Handle modal clicks outside content
        document.querySelectorAll('.modal').forEach(modal => {
            modal.addEventListener('click', function(e) {
                if (e.target === modal) {
                    closeModal(modal.id);
                }
            });
        });

        // Handle escape key to close modals
        document.addEventListener('keydown', function(e) {
            if (e.key === 'Escape') {
                document.querySelectorAll('.modal').forEach(modal => {
                    if (modal.style.display === 'flex') {
                        closeModal(modal.id);
                    }
                });
            }
        });
    </script>
</body>
</html>